{% extends "basic-structure-w-sidebar.html" %}
{% from "common/filters_sidebar.html" import render_filters_sidebar, render_filter_button %}
{% from "common/order_selector.html" import render_order_selector %}

{% block title %}Historial de cambios de {{ sitio.nombre }}{% endblock %}

{% block content %}
<div class="mx-auto min-w-full w-auto px-4 py-2">
    <!-- Header with title and back link -->
    <div class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-neutral-600">Historial de cambios de {{ sitio.nombre }}</h1>
        <a href="{{ url_for('sites.index') }}"
            class="inline-flex items-center gap-2 rounded-md border border-neutral-700 bg-neutral-800 px-3 py-2 text-sm font-medium text-neutral-200 transition hover:bg-neutral-700 hover:text-white"
            title="Volver al sitio">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M15 18l-6-6 6-6" />
            </svg>
            Volver al sitio
        </a>
    </div>
    <div class="border-b border-neutral-700 w-auto h-1 mx-auto"></div>

    <nav class="my-2 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <!-- Selector de ordenamiento -->
            {{ render_order_selector(
            orders=orders,
            order=order,
            action_url=url_for('site_history.index', sitio_id=sitio.id, **filtros),
            additional_params=filtros
            ) }}


            <!-- Botón de filtros -->
            {{ render_filter_button(
            active_filters_count=active_filters_count,
            reset_url=url_for('site_history.index', sitio_id=sitio.id, order=order)
            ) }}


        </div>
        {% if pagination %}
        {% if pagination.pages > 1 %}
        <div class="flex items-center justify-center gap-2">
            <!-- Botón anterior -->
            {% if pagination.has_prev %}
            <a href="{{ url_for(request.endpoint, sitio_id=sitio.id, page=pagination.prev_num, order=order, **filtros) }}"
                class="rounded-md bg-gray-300 px-3 py-1 text-gray-800 shadow hover:bg-gray-400">
                ← Anterior
            </a>
            {% endif %}

            <!-- Números de página -->
            {% for p in range(1, pagination.pages + 1) %}
            {% if p == pagination.page %}
            <span class="rounded-md bg-blue-600 px-3 py-1 text-white shadow">{{ p }}</span>
            {% else %}
            <a href="{{ url_for(request.endpoint, sitio_id=sitio.id, page=p, order=order, **filtros) }}"
                class="rounded-md bg-gray-200 px-3 py-1 text-gray-800 shadow hover:bg-gray-300">
                {{ p }}
            </a>
            {% endif %}
            {% endfor %}

            <!-- Botón siguiente -->
            {% if pagination.has_next %}
            <a href="{{ url_for(request.endpoint, sitio_id=sitio.id, page=pagination.next_num, order=order, **filtros) }}"
                class="rounded-md bg-gray-300 px-3 py-1 text-gray-800 shadow hover:bg-gray-400">
                Siguiente →
            </a>
            {% endif %}
        </div>
        {% else %}
        <!-- Caso de solo una página -->
        <div class="flex items-center justify-center gap-2">
            <span class="rounded-md bg-blue-600 px-3 py-1 text-white shadow">1</span>
        </div>
        {% endif %}
        {% endif %}

    </nav>

    {% if lista_de_cambios and lista_de_cambios|length > 0 %}
    <div class="space-y-16 mt-8">
        {% for change in lista_de_cambios %}
        {% include 'common/history/changes_card.html' %}
        {% endfor %}
    </div>
    {% else %}
    <div class="text-2xl text-center p-6 text-neutral-700">
        No hay cambios registrados para este sitio.
    </div>
    {% endif %}
</div>

<!-- Sidebar de filtros -->
{{ render_filters_sidebar(
filters_config=[
{
"id": "accion_filter",
"title": "Tipo de acción",
"type": "radio",
"name": "accion",
"options": [
{"value": HistoryAction.CREAR.value, "label": "Creación"},
{"value": HistoryAction.EDITAR.value, "label": "Edición"},
{"value": HistoryAction.ELIMINAR.value, "label": "Eliminación"},
{"value": HistoryAction.CAMBIAR_TAGS.value, "label": "Cambio de tags"},
{"value": HistoryAction.CAMBIAR_IMAGENES.value, "label": "Cambio de imágenes"}
]
},
{
"id": "usuario_filter",
"title": "Usuario",
"type": "radio",
"name": "usuario",
"options": usuarios_options
},
{
"id": "fecha_filter",
"title": "Rango de fechas",
"type": "date_range",
"name_from": "fecha_desde",
"name_to": "fecha_hasta"
}
],
action_url=url_for('site_history.index', sitio_id=sitio.id, order=order),
current_filters=filtros
) }}

<!-- Leaflet CSS y JS para los mapas -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
{% endblock %}