{% extends "basic-structure-w-sidebar.html" %}

{% block title %}Listado de Reseñas{% endblock %}

{% block content %}
<div class="w-full px-4 sm:px-8 lg:px-12">
    <h1 class="text-2xl font-bold text-gray-900 mb-4">Listado de Reseñas</h1>

    <!-- Filtros -->
    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">Filtros</h2>
        <form method="GET" action="{{ url_for('reviews.index') }}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Estado -->
            <div>
                <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                <select name="estado" id="estado" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="">Todos</option>
                    <option value="pendiente" {% if filtros.get('estado') == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="aprobada" {% if filtros.get('estado') == 'aprobada' %}selected{% endif %}>Aprobada</option>
                    <option value="rechazada" {% if filtros.get('estado') == 'rechazada' %}selected{% endif %}>Rechazada</option>
                </select>
            </div>

            <!-- Sitio -->
            <div>
                <label for="site_id" class="block text-sm font-medium text-gray-700 mb-1">Sitio</label>
                <select name="site_id" id="site_id" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="">Todos</option>
                    {% for site in sites %}
                    <option value="{{ site.id }}" {% if filtros.get('site_id') == site.id|string %}selected{% endif %}>{{ site.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Orden -->
            <div>
                <label for="order" class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
                <select name="order" id="order" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="fecha_desc" {% if filtros.get('order') == 'fecha_desc' %}selected{% endif %}>Fecha (más recientes)</option>
                    <option value="fecha_asc" {% if filtros.get('order') == 'fecha_asc' %}selected{% endif %}>Fecha (más antiguos)</option>
                    <option value="calificacion_desc" {% if filtros.get('order') == 'calificacion_desc' %}selected{% endif %}>Calificación (mayor a menor)</option>
                    <option value="calificacion_asc" {% if filtros.get('order') == 'calificacion_asc' %}selected{% endif %}>Calificación (menor a mayor)</option>
                </select>
            </div>

            <!-- Calificación mínima -->
            <div>
                <label for="calificacion_min" class="block text-sm font-medium text-gray-700 mb-1">Calificación mínima</label>
                <input type="number" name="calificacion_min" id="calificacion_min" min="1" max="5"
                       value="{{ filtros.get('calificacion_min', '') }}"
                       placeholder="1-5"
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Calificación máxima -->
            <div>
                <label for="calificacion_max" class="block text-sm font-medium text-gray-700 mb-1">Calificación máxima</label>
                <input type="number" name="calificacion_max" id="calificacion_max" min="1" max="5"
                       value="{{ filtros.get('calificacion_max', '') }}"
                       placeholder="1-5"
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Usuario (email) -->
            <div>
                <label for="user_email" class="block text-sm font-medium text-gray-700 mb-1">Usuario (email)</label>
                <input type="text" name="user_email" id="user_email"
                       value="{{ filtros.get('user_email', '') }}"
                       placeholder="Buscar por email..."
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Fecha desde -->
            <div>
                <label for="fecha_desde" class="block text-sm font-medium text-gray-700 mb-1">Fecha desde</label>
                <input type="date" name="fecha_desde" id="fecha_desde"
                       value="{{ filtros.get('fecha_desde', '') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Fecha hasta -->
            <div>
                <label for="fecha_hasta" class="block text-sm font-medium text-gray-700 mb-1">Fecha hasta</label>
                <input type="date" name="fecha_hasta" id="fecha_hasta"
                       value="{{ filtros.get('fecha_hasta', '') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Botones -->
            <div class="md:col-span-2 lg:col-span-3 flex gap-2 justify-end">
                <a href="{{ url_for('reviews.index') }}"
                   class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 text-sm font-medium">
                    Limpiar filtros
                </a>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                    Aplicar filtros
                </button>
            </div>
        </form>
    </div>

    <div class="mb-4">
        <p class="text-gray-600">Total: {{ pagination.total }} reseñas | Página {{ pagination.page }} de {{
            pagination.pages }}</p>
    </div>

    {% if items %}
    {% for review in items %}
    <div class="mb-6 p-4 border border-gray-300 rounded-lg bg-white shadow-sm">
        <div class="mb-3">
            <p class="text-sm text-gray-600"><strong>ID:</strong> {{ review.id }}</p>
            <p class="text-sm text-gray-600"><strong>Sitio:</strong> {{ review.site.nombre }}</p>
            <p class="text-sm text-gray-600"><strong>Usuario:</strong> {{ review.user.email }} ({{ review.user.username
                }})</p>
            <p class="text-sm text-gray-600"><strong>Calificación:</strong> {{ review.calificacion }}/5</p>
            <p class="text-sm text-gray-600"><strong>Contenido:</strong> {{ review.contenido }}</p>
            <p class="text-sm text-gray-600">
                <strong>Estado:</strong>
                <span class="px-2 py-1 rounded text-xs font-semibold
                            {% if review.estado.value == 'aprobada' %}bg-green-100 text-green-800
                            {% elif review.estado.value == 'rechazada' %}bg-red-100 text-red-800
                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                    {{ review.estado.value|upper }}
                </span>
            </p>
            {% if review.motivo_rechazo %}
            <p class="text-sm text-gray-600"><strong>Motivo de rechazo:</strong> {{ review.motivo_rechazo }}</p>
            {% endif %}
            <p class="text-sm text-gray-600"><strong>Fecha de creación:</strong> {{ review.created_at.strftime('%d/%m/%Y
                %H:%M') }}</p>
        </div>

        <!-- Botones de acción iniciales -->
        <div id="actions-{{ review.id }}" class="flex gap-2">
            <a href="{{ url_for('reviews.show', review_id=review.id) }}"
               class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                Ver detalle
            </a>
            {% if review.estado.value == 'pendiente' %}
            <button type="button" onclick="showApprove({{ review.id }})"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                Aprobar
            </button>
            <button type="button" onclick="showReject({{ review.id }})"
                class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                Rechazar
            </button>
            {% endif %}
            <button type="button" onclick="showDelete({{ review.id }})"
                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                Eliminar
            </button>
        </div>

        <!-- Sección de confirmación: APROBAR -->
        <div id="approve-section-{{ review.id }}" style="display: none;"
            class="mt-3 p-3 bg-green-50 border border-green-200 rounded">
            <h3 class="text-md font-semibold text-green-800 mb-3">¿Aprobar esta reseña?</h3>
            <form method="POST" action="{{ url_for('reviews.approve', review_id=review.id) }}" class="flex gap-2">
                <button type="button" onclick="hideConfirmation({{ review.id }})"
                    class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 text-sm">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                    Confirmar
                </button>
            </form>
        </div>

        <!-- Sección de confirmación: RECHAZAR -->
        <div id="reject-section-{{ review.id }}" style="display: none;"
            class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded">
            <h3 class="text-md font-semibold text-yellow-800 mb-3">Rechazar reseña</h3>
            <form method="POST" action="{{ url_for('reviews.reject', review_id=review.id) }}">
                <div class="mb-3">
                    <label for="motivo-{{ review.id }}" class="block text-sm font-medium text-gray-700 mb-1">
                        Motivo de rechazo (obligatorio, máx. 200 caracteres):
                    </label>
                    <textarea id="motivo-{{ review.id }}" name="motivo_rechazo" required maxlength="200" rows="3"
                        placeholder="Ingrese el motivo del rechazo..."
                        oninput="updateCharCounter({{ review.id }})"
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm"></textarea>
                    <p id="char-counter-{{ review.id }}" class="text-sm text-gray-500 mt-1">0 / 200 caracteres</p>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="hideConfirmation({{ review.id }})"
                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 text-sm">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                        Confirmar Rechazo
                    </button>
                </div>
            </form>
        </div>

        <!-- Sección de confirmación: ELIMINAR -->
        <div id="delete-section-{{ review.id }}" style="display: none;"
            class="mt-3 p-3 bg-red-50 border border-red-200 rounded">
            <h3 class="text-md font-semibold text-red-800 mb-3">¿Eliminar permanentemente esta reseña?</h3>
            <p class="text-sm text-red-700 mb-3">Esta acción no se puede deshacer.</p>
            <form method="POST" action="{{ url_for('reviews.delete', review_id=review.id) }}" class="flex gap-2">
                <button type="button" onclick="hideConfirmation({{ review.id }})"
                    class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 text-sm">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                    Confirmar Eliminación
                </button>
            </form>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-gray-500 italic">No hay reseñas para mostrar.</p>
    {% endif %}

    <!-- Paginación -->
    <div class="mt-6 mb-8 flex justify-center gap-2">
        {% if pagination.has_prev %}
        <a href="{{ url_for('reviews.index', page=pagination.prev_num) }}"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
            ← Anterior
        </a>
        {% endif %}

        <span class="px-4 py-2 bg-blue-600 text-white rounded">
            {{ pagination.page }}
        </span>

        {% if pagination.has_next %}
        <a href="{{ url_for('reviews.index', page=pagination.next_num) }}"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
            Siguiente →
        </a>
        {% endif %}
    </div>
</div>

<script>
    function showApprove(reviewId) {
        document.getElementById('actions-' + reviewId).style.display = 'none';
        document.getElementById('approve-section-' + reviewId).style.display = 'block';
    }

    function showReject(reviewId) {
        document.getElementById('actions-' + reviewId).style.display = 'none';
        document.getElementById('reject-section-' + reviewId).style.display = 'block';
        // Limpiar textarea y contador cuando se abre
        const textarea = document.getElementById('motivo-' + reviewId);
        textarea.value = '';
        updateCharCounter(reviewId);
    }

    function showDelete(reviewId) {
        document.getElementById('actions-' + reviewId).style.display = 'none';
        document.getElementById('delete-section-' + reviewId).style.display = 'block';
    }

    function hideConfirmation(reviewId) {
        document.getElementById('approve-section-' + reviewId).style.display = 'none';
        document.getElementById('reject-section-' + reviewId).style.display = 'none';
        document.getElementById('delete-section-' + reviewId).style.display = 'none';
        document.getElementById('actions-' + reviewId).style.display = 'flex';

        // Limpiar textarea cuando se cancela
        const textarea = document.getElementById('motivo-' + reviewId);
        if (textarea) {
            textarea.value = '';
            updateCharCounter(reviewId);
        }
    }

    function updateCharCounter(reviewId) {
        const textarea = document.getElementById('motivo-' + reviewId);
        const counter = document.getElementById('char-counter-' + reviewId);

        if (textarea && counter) {
            const length = textarea.value.length;
            counter.textContent = `${length} / 200 caracteres`;

            // Cambiar color si se acerca al límite
            if (length > 180) {
                counter.classList.add('text-red-600');
                counter.classList.remove('text-gray-500');
            } else {
                counter.classList.add('text-gray-500');
                counter.classList.remove('text-red-600');
            }
        }
    }
</script>
{% endblock %}