{# Macro para renderizar un sidebar de filtros reutilizable con secciones colapsables #}
{% from "common/checkbox_filter.html" import render_checkbox %}

{% macro render_filters_sidebar(filters_config, action_url, current_filters={}) %}
<!-- Overlay oscuro -->
<div id="filterOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity"
  onclick="toggleFilterSidebar()" aria-hidden="true"></div>

<!-- Sidebar de filtros -->
<aside id="filterSidebar" role="dialog" aria-modal="true" aria-labelledby="filterSidebarTitle"
  class="fixed top-0 right-0 h-full w-96 bg-neutral-900 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col border-l border-neutral-700">
  <!-- Header del sidebar -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-700 bg-neutral-800">
    <h3 id="filterSidebarTitle" class="text-lg font-bold text-neutral-100">Filtros</h3>
    <button onclick="toggleFilterSidebar()" aria-label="Cerrar panel de filtros"
      class="p-2 rounded-md hover:bg-neutral-700 transition-colors text-neutral-300 hover:text-white">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Contenido scrollable -->
  <form action="{{ action_url }}" method="get" class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
    {% for section in filters_config %}
    <!-- Sección colapsable -->
    <div class="border border-neutral-700 rounded-lg bg-neutral-800">
      <!-- Header de la sección -->
      <button type="button" onclick="toggleFilterSection('{{ section.id }}')" aria-expanded="false"
        aria-controls="{{ section.id }}-content"
        class="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-neutral-750 transition-colors rounded-t-lg">
        <span class="font-semibold text-neutral-100">{{ section.title }}</span>
        <svg id="{{ section.id }}-icon" class="w-5 h-5 text-neutral-400 transform transition-transform" fill="none"
          stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <!-- Contenido de la sección -->
      <div id="{{ section.id }}-content" class="hidden px-4 pb-3 space-y-1" role="region"
        aria-labelledby="{{ section.id }}-button">
        {% if section.type == 'checkbox' %}
        {% for option in section.options %}
        {{ render_checkbox(
        name=section.name,
        value=option.value,
        label=option.label,
        checked=(option.value in current_filters.get(section.name, [])) if current_filters.get(section.name) is iterable
        and current_filters.get(section.name) is not string else (option.value == current_filters.get(section.name)),
        count=option.count if option.count is defined else None
        ) }}
        {% endfor %}

        {% elif section.type == 'date_range' %}
        <div class="space-y-3">
          <div>
            <label for="{{ section.name_from }}" class="block text-sm font-medium text-neutral-300 mb-1">Desde</label>
            <input type="date" id="{{ section.name_from }}" name="{{ section.name_from }}"
              value="{{ current_filters.get(section.name_from, '') }}"
              class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-md text-neutral-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label for="{{ section.name_to }}" class="block text-sm font-medium text-neutral-300 mb-1">Hasta</label>
            <input type="date" id="{{ section.name_to }}" name="{{ section.name_to }}"
              value="{{ current_filters.get(section.name_to, '') }}"
              class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-md text-neutral-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>
        
        {% elif section.type == 'radio' %}
        {% for option in section.options %}
        <label
          class="flex items-center gap-3 cursor-pointer group py-2 px-3 rounded-md hover:bg-neutral-700 transition-colors">
          <input type="radio" name="{{ section.name }}" value="{{ option.value }}" {% if
            option.value==current_filters.get(section.name) %}checked{% endif %}
            class="w-4 h-4 border-neutral-600 bg-neutral-700 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
          <span class="text-sm text-neutral-200 group-hover:text-white transition-colors">
            {{ option.label }}
          </span>
        </label>
        {% endfor %}
         {% elif section.type == 'text' %}
          <input type="text" name="{{ section.name }}" value="{{ current_filters.get(section.name, '') }}"
                 class="w-full px-3 py-2 rounded-md bg-neutral-700 text-neutral-100 border border-neutral-600"
                 placeholder="{{ section.title }}">
        {% elif section.type == 'multiselect' %}
          {% for option in section.options %}
            <label
              class="flex items-center gap-3 cursor-pointer group py-2 px-3 rounded-md hover:bg-neutral-700 transition-colors">
              <input type="checkbox" 
                    name="{{ section.name }}" 
                    value="{{ option.value }}"
                    {% if option.value in current_filters.get(section.name, []) %}checked{% endif %}
                    class="w-4 h-4 border-neutral-600 bg-neutral-700 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
              <span class="text-sm text-neutral-200 group-hover:text-white transition-colors">
                {{ option.label }}
              </span>
            </label>
          {% endfor %}

          {% elif section.type == 'select' %}
          <label for="{{ section.id }}-select" class="block text-sm font-medium text-neutral-300 mb-1">{{ section.title }}</label>
          <select id="{{ section.id }}-select" name="{{ section.name }}" class="w-full px-3 py-2 bg-neutral-700 border border-neutral-600 rounded-md text-neutral-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">-- Selecciona {{ section.title }} --</option>
            {% for option in section.options %}
              <option value="{{ option.value }}" {% if option.value == current_filters.get(section.name) %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <!-- Botón aplicar sticky en el bottom -->
    <div
      class="sticky bottom-0 left-0 right-0 pt-4 pb-2 bg-gradient-to-t from-neutral-900 via-neutral-900 to-transparent">
      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors shadow-lg">
        Aplicar filtros
      </button>
    </div>
  </form>
</aside>

<script>
  function toggleFilterSidebar() {
    const sidebar = document.getElementById('filterSidebar');
    const overlay = document.getElementById('filterOverlay');
    const isOpen = !sidebar.classList.contains('translate-x-full');

    sidebar.classList.toggle('translate-x-full');
    overlay.classList.toggle('hidden');

    // Prevenir scroll del body cuando el sidebar está abierto
    document.body.style.overflow = sidebar.classList.contains('translate-x-full') ? 'auto' : 'hidden';

    // Gestionar foco para accesibilidad
    if (!isOpen) {
      // Sidebar se está abriendo - enfocar el primer elemento interactivo
      setTimeout(() => {
        const firstInput = sidebar.querySelector('input, button[type="button"]');
        if (firstInput) firstInput.focus();
      }, 300);
    }
  }

  function toggleFilterSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const icon = document.getElementById(sectionId + '-icon');
    const button = document.querySelector(`button[aria-controls="${sectionId}-content"]`);

    const isExpanded = !content.classList.contains('hidden');
    content.classList.toggle('hidden');
    icon.classList.toggle('rotate-180');

    // Actualizar aria-expanded para accesibilidad
    if (button) {
      button.setAttribute('aria-expanded', !isExpanded);
    }
  }

  // Gestión de teclado para accesibilidad
  document.addEventListener('keydown', function (e) {
    const sidebar = document.getElementById('filterSidebar');
    const isOpen = !sidebar.classList.contains('translate-x-full');

    // Cerrar sidebar con ESC
    if (e.key === 'Escape' && isOpen) {
      toggleFilterSidebar();
    }

    // Abrir sidebar con Ctrl+F o Cmd+F (prevenir búsqueda del navegador)
    if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !isOpen) {
      e.preventDefault();
      toggleFilterSidebar();
    }

    // Trap focus dentro del sidebar cuando está abierto
    if (isOpen && e.key === 'Tab') {
      const focusableElements = sidebar.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  });
</script>
{% endmacro %}

{# Macro para el botón flotante de apertura con contador de filtros activos #}
{% macro render_filter_button(active_filters_count=0, reset_url='') %}
<div class="flex items-center gap-2">


  <!-- Botón de filtros -->
  <button onclick="toggleFilterSidebar()"
    aria-label="Abrir panel de filtros{% if active_filters_count > 0 %} ({{ active_filters_count }} activos){% endif %}"
    class="relative inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium shadow-lg">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
    </svg>
    Filtros
    {% if active_filters_count > 0 %}
    <span
      class="absolute -top-2 -right-2 flex items-center justify-center w-6 h-6 text-xs font-bold text-white bg-red-600 rounded-full border-2 border-neutral-900"
      aria-label="{{ active_filters_count }} filtros activos">
      {{ active_filters_count }}
    </span>
    {% endif %}
  </button>


  <!-- Botón de reset rápido -->
  {% if active_filters_count > 0 %}
  <a href="{{ reset_url }}"
    class="inline-flex items-center gap-2 px-3 py-2 bg-neutral-700 hover:bg-neutral-600 text-neutral-200 rounded-lg transition-colors text-sm font-medium">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
    Resetear
  </a>
  {% endif %}
</div>
{% endmacro %}