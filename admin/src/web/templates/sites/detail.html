{% extends "basic-structure-w-footer.html" %}

{% block content %}
<div class="w-full px-4 py-4 sm:px-6 lg:px-12">
  <!-- Encabezado -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pb-4">
    <h1 class="text-xl font-bold text-gray-900 sm:text-2xl">
      Detalle del Sitio Hist√≥rico: {{ sitio.nombre }}
    </h1>

    <div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
      <!-- Volver al listado -->
      <a href="{{ url_for('sites.index') }}"
         class="inline-flex items-center justify-center rounded-md bg-gray-300 px-4 py-2 text-gray-800 font-medium shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-1">
        ‚Üê Volver
      </a>

      <!-- Ver historial -->
      {% if has_permission('site_history') %}
      <a href="{{ url_for('sites_history.index', sitio_id=sitio.id) }}"
         class="inline-flex items-center justify-center rounded-md bg-indigo-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-1">
        üìú Historial
      </a>
      {% endif %}

      <!-- Editar -->
      {% if has_permission('site_update') %}
      <a href="{{ url_for('sites.modify', site_id=sitio.id) }}"
         class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-1">
        ‚úèÔ∏è Editar
      </a>
      {% endif %}

      <!-- Eliminar -->
      {% if has_permission('site_destroy') %}
      <button onclick="openDeleteModal({ 
          url: '{{ url_for('sites.delete', site_id=sitio.id) }}', 
          title: 'Eliminar sitio',
          message: '¬øEst√°s seguro que quieres eliminar el sitio {{ sitio.nombre }}?'
      })"
      class="inline-flex items-center justify-center rounded-md bg-red-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1">
        üóëÔ∏è Eliminar
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Galer√≠a -->
    {% if sitio.images_data and sitio.images_data|length > 0 %}
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow p-4 sm:p-6">
        <h2 class="text-lg font-bold text-gray-800 mb-4">Galer√≠a</h2>
        <div class="relative group flex justify-center">
          <!-- Imagen principal -->
          <img id="mainGalleryImage" class="w-full h-64 sm:h-80 object-cover rounded-lg transition-opacity duration-500 opacity-100" src="" alt="Imagen sitio">

          <!-- Botones de swipe -->
          {% if sitio.images_data|length > 1 %}
          <button onclick="prevGalleryImage()"
                  class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-8 h-8 flex items-center justify-center transition-opacity duration-200 opacity-0 group-hover:opacity-100">
            ‚Äπ
          </button>
          <button onclick="nextGalleryImage()"
                  class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-8 h-8 flex items-center justify-center transition-opacity duration-200 opacity-0 group-hover:opacity-100">
            ‚Ä∫
          </button>
          <!-- Contador -->
          <div class="text-center mt-3 text-sm text-gray-600 absolute bottom-[-2.5rem] left-1/2 transform -translate-x-1/2">
            <span id="currentImageIndex">1</span> / <span id="totalImages">{{ sitio.images_data|length }}</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Informaci√≥n del sitio -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow p-4 sm:p-6 space-y-3 sm:space-y-4">
        <p><span class="font-semibold">Descripci√≥n breve:</span> {{ sitio.descripcion_breve }}</p>
        <p><span class="font-semibold">Descripci√≥n completa:</span> {{ sitio.descripcion_completa }}</p>
        <p><span class="font-semibold">Ciudad:</span> {{ sitio.ciudad }}</p>
        <p><span class="font-semibold">Provincia:</span> {{ sitio.provincia }}</p>
        <p><span class="font-semibold">Categor√≠a:</span> {{ sitio.categoria }}</p>
        <p><span class="font-semibold">Estado de conservaci√≥n:</span> {{ sitio.estado_conservacion }}</p>
        <p><span class="font-semibold">A√±o de inauguraci√≥n:</span> {{ sitio.inauguracion }}</p>
        <p><span class="font-semibold">Visible:</span> {{ 'S√≠' if sitio.visible else 'No' }}</p>
        <p><span class="font-semibold">Fecha de registro:</span> {{ sitio.created_at.strftime("%d/%m/%Y %H:%M") }}</p>

        <div class="grid grid-cols-1 gap-2 sm:grid-cols-12">
          <div class="sm:col-span-5 flex flex-col">
            <div class="font-semibold">Tags:</div>
            <div class="flex flex-wrap gap-1 mt-1">
              {% if sitio.tags|length > 0 %}
              {% for tag in sitio.tags %}
              <span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-neutral-700 text-neutral-300 rounded">
                #{{ tag.name }}
              </span>
              {% endfor %}
              {% else %}
              <span class="font-semibold">Sin tags</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mapa -->
  <div class="mt-6 bg-white rounded-lg shadow p-4 sm:p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Ubicaci√≥n</h2>
    <div id="map" class="w-full h-64 sm:h-80 rounded-lg border"></div>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
// Mapa
const lat = Number("{{ sitio.latitud or -34.6037 }}");
const lng = Number("{{ sitio.longitud or -58.3816 }}");
const map = L.map("map").setView([lat, lng], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);
L.marker([lat, lng]).addTo(map).bindPopup("{{ sitio.nombre }}").openPopup();
let images = {{ sitio.images_data|tojson }} || [];
images = images.filter(i => i && i.url); // solo v√°lidas

// Separar portada
let portada = images.find(i => i.is_cover);
let resto = images.filter(i => !i.is_cover);

// Ordenar el resto por order ascendente
resto.sort((a,b) => (a.order||0)-(b.order||0));

// Combinar portada + resto
images = portada ? [portada, ...resto] : resto;

// Mapear solo lo necesario para la galer√≠a
images = images.map(i => ({ url: i.url, title: i.title||'' }));

let currentIndex = 0;


function updateMainGalleryDisplay() {
  const img = images[currentIndex];
  const el = document.getElementById("mainGalleryImage");
  if (!el) return;

  el.classList.remove('opacity-100');
  el.classList.add('opacity-0');

  el.onload = function() {
    el.classList.remove('opacity-0');
    el.classList.add('opacity-100');
    const idx = document.getElementById("currentImageIndex");
    if (idx) idx.innerText = currentIndex + 1;
  };
  el.src = img.url;
}

function nextGalleryImage() {
  currentIndex = (currentIndex + 1) % images.length;
  updateMainGalleryDisplay();
}

function prevGalleryImage() {
  currentIndex = (currentIndex - 1 + images.length) % images.length;
  updateMainGalleryDisplay();
}

// Inicializar
// Inicializar
if (images.length > 0) {
  const totalEl = document.getElementById('totalImages');
  if(totalEl) totalEl.innerText = images.length; // solo si existe
  updateMainGalleryDisplay();
}

</script>

{% include "common/delete_modal.html" %}
{% endblock %}
