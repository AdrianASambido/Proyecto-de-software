{% extends "common/tables_base.html" %}
{% from "common/filters_sidebar.html" import render_filters_sidebar, render_filter_button %}
{% from "common/order_selector.html" import render_order_selector %}

{% block table_title %}Sitios Históricos{% endblock %}
{% block add_url %}{{ url_for('sites.add_site') }}{% endblock %}
{% block add_label %}Agregar sitio{% endblock %}

{% block table_filters %}
  {% set active_filters_count = (
    (request.args.get('busqueda') or
     request.args.get('ciudad') or
     request.args.get('provincia') or
     request.args.get('estado_conservacion') or
     request.args.get('fecha_desde') or
     request.args.get('fecha_hasta') or
     request.args.get('visible') or
     request.args.getlist('tags'))
     and 1 or 0
  ) %}

  <div class="flex items-center gap-3">
    <!-- Botón de filtros -->
    {{ render_filter_button(active_filters_count, reset_url=url_for('sites.index')) }}

    <!-- Selector de orden -->
    {% set order_options = [
      {'value': 'fecha_desc', 'label': 'Fecha (más recientes)'},
      {'value': 'fecha_asc', 'label': 'Fecha (más antiguos)'},
      {'value': 'nombre_asc', 'label': 'Nombre (A–Z)'},
      {'value': 'nombre_desc', 'label': 'Nombre (Z–A)'},
      {'value': 'ciudad_asc', 'label': 'Ciudad (A–Z)'},
      {'value': 'ciudad_desc', 'label': 'Ciudad (Z–A)'}
    ] %}
    {{ render_order_selector(order_options, order or '', url_for('sites.index'), request.args.to_dict(flat=False)) }}
  </div>
{% block results_counter %}
  {% if items|length > 0 %}
    {% set start = (pagination.page - 1) * pagination.per_page + 1 %}
    {% set end = start + items|length - 1 %}
    <p class="mb-2 text-sm text-gray-600">
      Mostrando {{ start }}–{{ end }} de {{ pagination.total }} resultados
    </p>
  {% endif %}
{% endblock %}



{% endblock %}

{% block extra_actions %}
  {% if has_permission('site_export') %}
    <a href="{{ url_for('sites.export', **request.args.to_dict(flat=False)) }}"
       class="rounded-lg bg-green-600 px-4 py-2 text-sm text-white font-medium shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
      Exportar CSV
    </a>
  {% endif %}
{% endblock %}

{% block table_headers %}

{% endblock %}

{% block table_rows %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {% for sitio in items %}
    <div class="border rounded-lg shadow-sm bg-white p-4 flex flex-col justify-between hover:shadow-md transition">
      <!-- Contenido principal -->
      <div class="flex gap-4 items-start">
        <!-- Imagen del sitio -->
        <div class="w-24 h-24 flex-shrink-0 bg-gray-100 border rounded overflow-hidden flex items-center justify-center">
          {% if sitio.imagen_url %}
            <img src="{{ sitio.imagen_url }}" alt="{{ sitio.nombre }}" class="w-full h-full object-cover">
          {% else %}
            <span class="text-gray-500 text-xs italic">Sin imagen</span>
          {% endif %}
        </div>

        <!-- Información -->
        <div class="flex-1">
          <p class="font-semibold text-lg text-gray-800">{{ sitio.nombre }}</p>
          <p class="text-sm text-gray-600"><span class="font-medium">Ciudad:</span> {{ sitio.ciudad }}</p>
          <p class="text-sm text-gray-600"><span class="font-medium">Provincia:</span> {{ sitio.provincia }}</p>
          <p class="text-sm text-gray-600"><span class="font-medium">Estado:</span> {{ sitio.estado_conservacion }}</p>
          <p class="text-sm text-gray-600"><span class="font-medium">Visible:</span> {{ 'Sí' if sitio.visible else 'No' }}</p>
          <p class="text-xs text-gray-500 mt-1"><span class="font-medium">Registrado:</span> {{ sitio.created_at.strftime("%d/%m/%Y %H:%M") }}</p>
        </div>
      </div>

      <!-- Acciones dentro de la tarjeta -->
      <div class="flex justify-end gap-2 mt-4">
        {% if has_permission('site_show') %}
         <a href="{{ url_for('sites.detail', sitio_id=sitio.id) }}"
            title="Ver detalles"
            class="flex items-center justify-center w-8 h-8 rounded bg-blue-500 text-white hover:bg-blue-600">
            <img src="{{ url_for('static', filename='icons/details.svg') }}" alt="Detalles" class="h-4 w-4 inline" />
          </a>
        {% endif %}

        {% if has_permission('site_update') %}
         <a href="{{ url_for('sites.modify', site_id=sitio.id) }}"
            title="Editar "
            class="flex items-center justify-center w-8 h-8 rounded bg-blue-500 text-white hover:bg-blue-600">
            <img src="{{ url_for('static', filename='icons/edit.svg') }}" alt="Modificar" class="h-4 w-4 inline" />
          </a>
        {% endif %}

         {% if has_permission('site_destroy') %}
              {% set delete_url = url_for('sites.delete', site_id=sitio.id) %}
    <button type="button"
            onclick='openDeleteModal({{ {
              "url": delete_url,
              "title": "¿Eliminar sitio?",
              "message": "¿Estás seguro que deseas eliminar este sitio? Esta acción no se puede deshacer."
            } | tojson }})'
            title="Eliminar"
            class="flex items-center justify-center w-8 h-8 rounded bg-red-500 text-white hover:bg-red-600">
      <img src="{{ url_for('static', filename='icons/delete.svg') }}" alt="Eliminar" class="h-4 w-4 inline" />
    </button>
          {% endif %}

       
       
      </div>
    </div>
  {% else %}
    <div class="col-span-full text-center text-gray-500 text-sm py-10">
      No se encontraron resultados.
    </div>
  {% endfor %}
</div>

  
{% endblock %}

{% block table_pagination %}
  {% if pagination %}
    <div class="mt-6 flex items-center justify-center gap-2">
      {% if pagination.has_prev %}
        <a href="{{ url_for(request.endpoint, page=pagination.prev_num, **filtros) }}"
           class="rounded-md bg-gray-300 px-3 py-1 text-gray-800 shadow hover:bg-gray-400">← Anterior</a>
      {% endif %}

      {% for p in range(1, pagination.pages + 1) %}
        {% if p == pagination.page %}
          <span class="rounded-md bg-blue-600 px-3 py-1 text-white shadow">{{ p }}</span>
        {% else %}
          <a href="{{ url_for(request.endpoint, page=p, **filtros) }}"
             class="rounded-md bg-gray-200 px-3 py-1 text-gray-800 shadow hover:bg-gray-300">{{ p }}</a>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
        <a href="{{ url_for(request.endpoint, page=pagination.next_num, **filtros) }}"
           class="rounded-md bg-gray-300 px-3 py-1 text-gray-800 shadow hover:bg-gray-400">Siguiente →</a>
      {% endif %}
    </div>
  {% endif %}
  
{% endblock %}

{% block content %}
  {{ super() }}

  {% set filters_config = [
    {'id': 'busqueda', 'title': 'Buscar', 'type': 'text', 'name': 'busqueda'},
    {'id': 'ciudad', 'title': 'Ciudad', 'type': 'text', 'name': 'ciudad'},
    {'id': 'provincia', 'title': 'Provincia', 'type': 'select', 'name': 'provincia', 'options': provincias},
    {'id':'tags', 'title':'Tags', 'type':'multiselect', 'name':'tags','options':tags},
    {'id': 'estado', 'title': 'Estado de conservación', 'type': 'radio', 'name': 'estado_conservacion', 'options': [
        {'value': 'Bueno', 'label': 'Bueno'},
        {'value': 'Regular', 'label': 'Regular'},
        {'value': 'Malo', 'label': 'Malo'}
    ]},
    {'id': 'fecha', 'title': 'Fecha de creación', 'type': 'date_range', 'name_from': 'fecha_desde','name_to': 'fecha_hasta'},
    {'id': 'visible', 'title': 'Visibilidad', 'type': 'radio', 'name': 'visible','options': [{'value': 'Si', 'label': 'Si'},{'value':'No','label':'No'}]}
  ] %}

  {{ render_filters_sidebar(filters_config, url_for('sites.index'), request.args.to_dict(flat=False)) }}

  {% include "common/delete_modal.html" %}
  
{% endblock %}
