{% extends "common/tables_base.html" %}
{% from "common/_form.html" import render_form %}
{% from "common/filters_sidebar.html" import render_filters_sidebar, render_filter_button %}
{% from "common/order_selector.html" import render_order_selector %}
{% from "common/checkbox_filter.html" import render_checkbox %}

{% block table_title %}Sitios Históricos{% endblock %}
{% block add_url %}{{ url_for('sites.add_site') }}{% endblock %}
{% block add_label %}Agregar sitio{% endblock %}
{% block extra_actions %}
<a href="{{ url_for('sites.export', **filtros) }}"
   class="rounded-lg bg-green-600 px-4 py-2 text-sm text-white font-medium shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2"
   aria-label="Exportar CSV">
  ⬇ Exportar CSV
</a>
{% endblock %}
{% block table_filters %}
{# Preparar opciones para los filtros #}
{% set provincia_options = [] %}
{% for prov in provincias %}
  {% set _ = provincia_options.append({'value': prov, 'label': prov}) %}
{% endfor %}

{% set tags_options = [] %}
{% for tag in tags %}
  {% set _ = tags_options.append({'value': tag.id, 'label': tag.nombre}) %}
{% endfor %}

{% set estado_options = [
  {'value':'Bueno','label':'Bueno'},
  {'value':'Regular','label':'Regular'},
  {'value':'Malo','label':'Malo'}
] %}

{# Renderizar botón flotante de filtros #}
{{ render_filter_button(active_filters_count=(request.args|length), reset_url=url_for('sites.index')) }}

{# Renderizar selector de orden #}
{{ render_order_selector(
    orders=[
        {'value':'fecha_desc','label':'Fecha ↓'},
        {'value':'fecha_asc','label':'Fecha ↑'},
        {'value':'nombre_asc','label':'Nombre ↑'},
        {'value':'nombre_desc','label':'Nombre ↓'},
        {'value':'ciudad_asc','label':'Ciudad ↑'},
        {'value':'ciudad_desc','label':'Ciudad ↓'}
    ],
    order=request.args.get('orden',''),
    action_url=url_for('sites.index'),
    additional_params=request.args.to_dict()
) }}

{# Renderizar sidebar de filtros usando macro #}
{{ render_filters_sidebar(
     filters_config=[
       {
         'id':'filtro_busqueda',
         'title':'Buscar',
         'type':'text',
         'name':'busqueda',
       },
       {
         'id':'filtro_ciudad',
         'title':'Ciudad',
         'type':'text',
         'name':'ciudad',
       },
       {
         'id':'filtro_provincia',
         'title':'Provincia',
         'type':'select',
         'name':'provincia',
         'options': provincia_options
       },
       {
         'id':'filtro_tags',
         'title':'Tags',
         'type':'checkbox',
         'name':'tags',
         'options': tags_options
       },
       {
         'id':'filtro_estado',
         'title':'Estado de conservación',
         'type':'select',
         'name':'estado_conservacion',
         'options': estado_options
       },
       {
         'id':'filtro_visible',
         'title':'Visible',
         'type':'checkbox',
         'name':'visible',
         'options':[{'value':'1','label':'Visible'}]
       },
       {
         'id':'filtro_fecha',
         'title':'Fecha de registro',
         'type':'date_range',
         'name_from':'fecha_desde',
         'name_to':'fecha_hasta'
       }
     ],
     action_url=url_for('sites.index'),
     current_filters=request.args.to_dict(flat=False)
) }}
{% endblock %}

{% block table_headers %}
<th class="px-3 py-2 text-left">Nombre</th>
<th class="px-3 py-2 text-left">Ciudad</th>
<th class="px-3 py-2 text-left">Provincia</th>
<th class="px-3 py-2 text-left">Descripción breve</th>
<th class="px-3 py-2 text-left">Estado de conservación</th>
<th class="px-3 py-2 text-left">Visible</th>
<th class="px-3 py-2 text-left">Fecha de registro</th>
<th class="px-3 py-2 text-left">Acciones</th>
{% endblock %}

{% block table_rows %}
{% for sitio in items %}
<tr class="hover:bg-gray-50 divide-y divide-gray-200">
  <td class="px-3 py-2 whitespace-nowrap">{{ sitio.nombre }}</td>
  <td class="px-3 py-2 whitespace-nowrap">{{ sitio.ciudad }}</td>
  <td class="px-3 py-2 whitespace-nowrap">{{ sitio.provincia }}</td>
  <td class="px-3 py-2">{{ sitio.descripcion_breve }}</td>
  <td class="px-3 py-2 whitespace-nowrap">{{ sitio.estado_conservacion }}</td>
  <td class="px-3 py-2 whitespace-nowrap">{{ 'Sí' if sitio.visible else 'No' }}</td>
  <td class="px-3 py-2 whitespace-nowrap">{{ sitio.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
  <td class="px-3 py-2 flex gap-2">
    {% set details_url = url_for('sites.detail', sitio_id=sitio.id) %}
    {% set edit_url = url_for('sites.modify', site_id=sitio.id) %}
    {% set delete_url = url_for('sites.delete', site_id=sitio.id) %}
    {% include "common/actions.html" %}
  </td>
</tr>
{% else %}
<tr>
  <td colspan="8" class="text-center text-gray-500 py-4 italic">No se encontraron resultados.</td>
</tr>
{% endfor %}
{% endblock %}

{% include "common/delete_modal.html" %}
