{% extends "common/tables_base.html" %}
{% from "common/filters_sidebar.html" import render_filters_sidebar, render_filter_button %}
{% from "common/order_selector.html" import render_order_selector %}

{% block table_title %}Sitios Históricos{% endblock %}
{% block add_url %}{{ url_for('sites.add_site') }}{% endblock %}
{% block add_label %}Agregar sitio{% endblock %}

{% block table_filters %}
  {% set active_filters_count = (
    (request.args.get('busqueda') or
     request.args.get('ciudad') or
     request.args.get('provincia') or
     request.args.get('estado_conservacion') or
     request.args.get('fecha_desde') or
     request.args.get('fecha_hasta') or
     request.args.get('visible') or
     request.args.getlist('tags'))
     and 1 or 0
  ) %}

  <div class="flex items-center gap-3">
    <!-- Botón de filtros -->
    {{ render_filter_button(active_filters_count, reset_url=url_for('sites.index')) }}

    <!-- Selector de orden -->
    {% set order_options = [
      {'value': 'fecha_desc', 'label': 'Fecha (más recientes)'},
      {'value': 'fecha_asc', 'label': 'Fecha (más antiguos)'},
      {'value': 'nombre_asc', 'label': 'Nombre (A–Z)'},
      {'value': 'nombre_desc', 'label': 'Nombre (Z–A)'},
      {'value': 'ciudad_asc', 'label': 'Ciudad (A–Z)'},
      {'value': 'ciudad_desc', 'label': 'Ciudad (Z–A)'}
    ] %}
    {{ render_order_selector(order_options, order or '', url_for('sites.index'), request.args.to_dict(flat=False)) }}
  </div>
{% endblock %}

{% block extra_actions %}
  {% if has_permission('site_export') %}
    <a href="{{ url_for('sites.export', **request.args.to_dict(flat=False)) }}"
       class="rounded-lg bg-green-600 px-4 py-2 text-sm text-white font-medium shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
      Exportar CSV
    </a>
  {% endif %}
{% endblock %}

{% block table_headers %}
  <th class="px-3 py-2 text-left">Nombre</th>
  <th class="px-3 py-2 text-left">Ciudad</th>
  <th class="px-3 py-2 text-left">Provincia</th>
  <th class="px-3 py-2 text-left">Descripción breve</th>
  <th class="px-3 py-2 text-left">Estado de conservación</th>
  <th class="px-3 py-2 text-left">Visible</th>
  <th class="px-3 py-2 text-left">Fecha de registro</th>
  <th class="px-3 py-2 text-left">Acciones</th>
{% endblock %}

{% block table_rows %}
  {% for sitio in items %}
  <tr class="hover:bg-gray-50">
    <td>{{ sitio.nombre }}</td>
    <td>{{ sitio.ciudad }}</td>
    <td>{{ sitio.provincia }}</td>
    <td>{{ sitio.descripcion_breve }}</td>
    <td>{{ sitio.estado_conservacion }}</td>
    <td>{{ 'Sí' if sitio.visible else 'No' }}</td>
    <td>{{ sitio.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
    <td class="flex gap-2">
      {% set details_url = url_for('sites.detail', sitio_id=sitio.id) %}
      {% set edit_url = url_for('sites.modify', site_id=sitio.id) %}
      {% if has_permission('site_destroy') %}
        {% set delete_url = url_for('sites.delete', site_id=sitio.id) %}
      {% endif %}
      {% include "common/actions.html" %}
    </td>
  </tr>
  {% else %}
  <tr>
    <td colspan="13" class="text-center text-gray-500 py-4">
      No se encontraron resultados.
    </td>
  </tr>
  {% endfor %}
{% endblock %}

{% block table_pagination %}
  {% if pagination %}
    <div class="mt-6 flex items-center justify-center gap-2">
      {% if pagination.has_prev %}
        <a href="{{ url_for(request.endpoint, page=pagination.prev_num, **filtros) }}"
           class="rounded-md bg-gray-300 px-3 py-1 text-gray-800 shadow hover:bg-gray-400">← Anterior</a>
      {% endif %}

      {% for p in range(1, pagination.pages + 1) %}
        {% if p == pagination.page %}
          <span class="rounded-md bg-blue-600 px-3 py-1 text-white shadow">{{ p }}</span>
        {% else %}
          <a href="{{ url_for(request.endpoint, page=p, **filtros) }}"
             class="rounded-md bg-gray-200 px-3 py-1 text-gray-800 shadow hover:bg-gray-300">{{ p }}</a>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
        <a href="{{ url_for(request.endpoint, page=pagination.next_num, **filtros) }}"
           class="rounded-md bg-gray-300 px-3 py-1 text-gray-800 shadow hover:bg-gray-400">Siguiente →</a>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block content %}
  {{ super() }}

  {% set filters_config = [
    {'id': 'busqueda', 'title': 'Buscar', 'type': 'text', 'name': 'busqueda'},
    {'id': 'ciudad', 'title': 'Ciudad', 'type': 'text', 'name': 'ciudad'},
    {'id': 'provincia', 'title': 'Provincia', 'type': 'select', 'name': 'provincia', 'options': provincias},
    {'id':'tags', 'title':'Tags', 'type':'multiselect', 'name':'tags','options':tags},
    {'id': 'estado', 'title': 'Estado de conservación', 'type': 'radio', 'name': 'estado_conservacion', 'options': [
        {'value': 'Bueno', 'label': 'Bueno'},
        {'value': 'Regular', 'label': 'Regular'},
        {'value': 'Malo', 'label': 'Malo'}
    ]},
    {'id': 'fecha', 'title': 'Fecha de creación', 'type': 'date_range', 'name_from': 'fecha_desde','name_to': 'fecha_hasta'},
    {'id': 'visible', 'title': 'Visibilidad', 'type': 'radio', 'name': 'visible','options': [{'value': 'Si', 'label': 'Si'},{'value':'No','label':'No'}]}
  ] %}

  {{ render_filters_sidebar(filters_config, url_for('sites.index'), request.args.to_dict(flat=False)) }}

  {% include "common/delete_modal.html" %}
{% endblock %}
