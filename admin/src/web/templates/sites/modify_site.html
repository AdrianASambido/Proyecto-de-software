 {% extends "basic-structure-w-sidebar.html" %}
{% from "common/_form.html" import render_form %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Modificar sitio histórico</h2>
{% call render_form(
    action=url_for('sites.modify', site_id=site.id),
    fields=[
      {"name": "nombre","label": "Nombre","type":"text","value": site.nombre,"required":True},
      {"name": "descripcion_breve","label":"Descripción breve","type":"text","value": site.descripcion_breve,"required":True},
      {"name": "descripcion_completa","label":"Descripción completa","type":"text","value": site.descripcion_completa,"required":True},
      {"name": "ciudad","label":"Ciudad","type":"text","value": site.ciudad,"required":True},
      {"name": "provincia","label":"Provincia","type":"text","value": site.provincia,"required":True},
      {"name": "inauguracion","label":"Año de inauguración","type":"number","max":2024,"value": site.inauguracion,"required":True},
      {"name": "estado_conservacion","label":"Estado de conservación","type":"select",
       "options":[{"value":"Bueno","label":"Bueno"},{"value":"Regular","label":"Regular"},{"value":"Malo","label":"Malo"}],
       "value": site.estado_conservacion,"required":True},
      {"name": "categoria","label":"Categoría","type":"text","value": site.categoria,"required":True},
      {"name": "visible","label":"Visible","type":"checkbox","checked": site.visible}
    ],
    submit_text="Guardar cambios") %}
  <label class="block font-semibold mt-4">Ubicación en el mapa</label>
  <div id="map" class="w-full h-96 border border-gray-300 rounded-lg"></div>

  <div class="flex gap-4 mt-4">
    <div class="flex-1">
      <label for="latitud">Latitud</label>
      <input type="number" step="any" id="latitud" name="latitud" class="border rounded p-2 w-full"
             value="{{ site.latitud }}" readonly>
    </div>
    <div class="flex-1">
      <label for="longitud">Longitud</label>
      <input type="number" step="any" id="longitud" name="longitud" class="border rounded p-2 w-full"
             value="{{ site.longitud }}" readonly>
    </div>
  </div> 
{% endcall %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>

  const lat = Number('{{ site.latitud or -34.6037 }}');
  const lng = Number('{{ site.longitud or -58.3816 }}');
  const map = L.map('map').setView([lat, lng], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  let marker = L.marker([lat, lng]).addTo(map);

  map.on('click', function(e) {
    const newLat = e.latlng.lat.toFixed(6);
    const newLng = e.latlng.lng.toFixed(6);
    document.getElementById('latitud').value = newLat;
    document.getElementById('longitud').value = newLng;
    if (marker) map.removeLayer(marker);
    marker = L.marker([newLat, newLng]).addTo(map);
  });
</script>
{% endblock %}
