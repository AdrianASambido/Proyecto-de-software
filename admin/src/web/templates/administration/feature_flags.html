{% extends "basic-structure-w-sidebar.html" %}

{% block title %}Feature Flags - Administración{% endblock %}

{% block content %}
<div class="w-full px-4 sm:px-8 lg:px-12 py-6">

  <!-- Encabezado -->
  <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Administración de Feature Flags</h1>
  </div>

  <!-- Nota -->
  <div class="mb-6 rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-sm text-blue-800">
    <strong class="font-semibold">Nota:</strong> Solo los <em>System Admins</em> pueden gestionar estos flags.
    Los cambios afectan inmediatamente a toda la aplicación.
  </div>

  <!-- Tabla -->
  <div class="w-full space-y-4">
  {% for flag in flags %}
  <div
    class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 sm:p-6 transition hover:shadow-md">
    
    <!-- Cabecera: nombre y estado -->
    <div class="flex flex-wrap items-center justify-between gap-2 border-b pb-2 mb-2">
      <h2 class="text-lg font-semibold text-gray-900">{{ flag.name }}</h2>
      <span id="status-{{ flag.id }}"
        class="inline-block rounded-full px-3 py-1 text-xs font-semibold text-white
        {% if flag.is_enabled %}bg-green-600{% else %}bg-red-500{% endif %}">
        {% if flag.is_enabled %}ON{% else %}OFF{% endif %}
      </span>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 text-sm text-gray-700">
      <div>
        <p class="font-semibold text-gray-900">Descripción:</p>
        <p>{{ flag.description or "-" }}</p>
      </div>
      <div>
        <p class="font-semibold text-gray-900">Mensaje de Mantenimiento:</p>
        <p id="message-{{ flag.id }}">{{ flag.maintenance_message or "-" }}</p>
      </div>
      <div>
        <p class="font-semibold text-gray-900">Última Modificación:</p>
        <p>{{ flag.last_modified_at.strftime("%d-%m-%Y %H:%M") or "-" }}</p>
      </div>
      <div>
        <p class="font-semibold text-gray-900">Modificado por:</p>
        <p>{{ flag.last_modified_by or "-" }}</p>
      </div>
      <div class="sm:col-span-2 md:col-span-3 mt-2">
        {% if is_system_admin_user %} 
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" class="peer flag-toggle hidden" id="toggle-{{ flag.id }}"
            data-flag-id="{{ flag.id }}" data-flag-name="{{ flag.name }}"
            {% if flag.is_enabled %}checked{% endif %}>
          <div
            class="relative w-11 h-6 bg-gray-300 rounded-full peer-checked:bg-blue-600 transition-all duration-300">
            <span
              class="absolute top-[2px] left-[2px] h-5 w-5 bg-white rounded-full transition-all duration-300 peer-checked:translate-x-full"></span>
          </div>
          <span class="ml-2 text-sm text-gray-700">
            {% if flag.is_enabled %}Desactivar{% else %}Activar{% endif %}
          </span>
        </label>
        {% else %}
        <span class="text-gray-400 text-sm">Solo System Admin</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center py-6 text-gray-500 italic border rounded-lg bg-white">
    No hay feature flags definidas.
  </div>
  {% endfor %}
</div>


  <!-- Modal de mensaje de mantenimiento -->
  <div id="maintenanceModal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900/50 backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-auto">
      <div class="border-b px-6 py-4 flex justify-between items-center">
        <h5 class="text-lg font-semibold text-gray-800">Configurar Mensaje de Mantenimiento</h5>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      </div>
      <div class="p-6">
        <form id="maintenanceForm">
          <label for="maintenanceMessage" class="block text-sm font-medium text-gray-700 mb-2">Mensaje de
            Mantenimiento</label>
          <textarea id="maintenanceMessage"
            class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-400 focus:outline-none"
            rows="3" maxlength="500"
            placeholder="Ingrese el mensaje que se mostrará durante el mantenimiento..."></textarea>
          <p class="text-xs text-gray-500 mt-1">Máximo 500 caracteres</p>
          <input type="hidden" id="currentFlagId">
        </form>
      </div>
      <div class="border-t px-6 py-3 flex justify-end gap-2">
        <button id="cancelModal"
          class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Cancelar</button>
        <button id="saveMaintenanceMessage"
          class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggles = document.querySelectorAll('.flag-toggle');
    const modal = document.getElementById('maintenanceModal');
    const closeModal = document.getElementById('closeModal');
    const cancelModal = document.getElementById('cancelModal');

    toggles.forEach(toggle => { // para cada toggle 
      toggle.addEventListener('change', function () {
        const flagId = this.dataset.flagId;     // Obtenemos el ID del flag
        const flagName = this.dataset.flagName; // Obtenemos el nombre del flag
        const isEnabled = this.checked;         // El estado, activado o desactivado.

        // Si es un flag de mantenimiento, abrir modal
        if (isEnabled && flagName.includes('maintenance_mode')) {
          document.getElementById('currentFlagId').value = flagId;
          document.getElementById('maintenanceMessage').value = '';
          modal.classList.remove('hidden');
        } else {
          updateFlag(flagId, isEnabled, '');
        }
      });
    });

    closeModal.addEventListener('click', () => modal.classList.add('hidden'));
    cancelModal.addEventListener('click', () => modal.classList.add('hidden'));

    document.getElementById('saveMaintenanceMessage').addEventListener('click', () => {
      const flagId = document.getElementById('currentFlagId').value;
      const message = document.getElementById('maintenanceMessage').value.trim();
      if (!message) {
        alert('El mensaje de mantenimiento es obligatorio.');
        return;
      }
      updateFlag(flagId, true, message);
      modal.classList.add('hidden');
    });
    // Se ejecuta si se escribe un mensaje de mantenimiento o si se activa/desactiva un flag normal
    function updateFlag(flagId, isEnabled, maintenanceMessage) { 
      fetch(`/admin/feature-flags/toggle/${flagId}`, { //petición de http POST 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          is_enabled: isEnabled,
          maintenance_message: maintenanceMessage,
         
        })
      })
        .then(res => res.json())
        .then(data => {
          const toggle = document.getElementById('toggle-' + flagId);
          const statusBadge = document.getElementById('status-' + flagId);
          const messageSpan = document.getElementById('message-' + flagId);

          if (data.success) {
            statusBadge.textContent = isEnabled ? 'ON' : 'OFF';
            statusBadge.className = `inline-block rounded-full px-3 py-1 text-xs font-semibold text-white ${isEnabled ? 'bg-green-600' : 'bg-red-500'}`;
            messageSpan.textContent = maintenanceMessage || '-';

            // Animación toggle
            if (isEnabled) {
              toggle.checked = true;
              toggle.nextElementSibling.querySelector('span').classList.add('translate-x-full');
            } else {
              toggle.checked = false;
              toggle.nextElementSibling.querySelector('span').classList.remove('translate-x-full');
            }

            showToast('Feature flag actualizado correctamente', 'success');
          } else {
            toggle.checked = !isEnabled;
            showToast('Error: ' + data.message, 'error');
          }
        })
        .catch(() => {
          showToast('Error al actualizar el feature flag', 'error');
        });
    }

    function showToast(message, type) {
      const colors = {
        success: 'bg-green-600 text-white',
        error: 'bg-red-600 text-white'
      };
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg ${colors[type]} animate-fade-in`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }
  });
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>

{% endblock %}